{% extends "crm/base.html" %}

{% block title %}Edit Customer - Floral CRM{% endblock %}

{% load humanize %}

{% block content %}
<div class="container">
    <div class="form-container bg-light p-4 rounded shadow-sm">
        <h2 class="mb-4">Edit Customer</h2>

        <!-- Show any form errors -->
        {% if form.errors %}
            <div class="alert alert-danger">
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            
            <!-- Name Field -->
            <div class="mb-3">
                <label for="id_name" class="form-label font-weight-bold">Customer Name:</label>
                <input type="text" id="id_name" name="name" class="form-control" value="{{ form.name.value }}" required>
            </div>

            <!-- Estimated Yearly Sales Field (Formatted with JS) -->
            <div class="mb-3">
                <label for="id_estimated_yearly_sales" class="form-label font-weight-bold">Estimated Yearly Sales:</label>
                <input type="text" id="id_estimated_yearly_sales" name="estimated_yearly_sales" class="form-control" 
                       value="{{ form.estimated_yearly_sales.value|floatformat:0|intcomma }}" required>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="{% url 'crm:dashboard' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var salesInput = document.getElementById("id_estimated_yearly_sales");

        // Function to format the input while typing
        function formatNumberInput(value) {
            return value.replace(/\D/g, "")  // Remove non-digit characters
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ","); // Add commas
        }

        // Format existing value on page load
        salesInput.value = formatNumberInput(salesInput.value);

        // Listen for input event
        salesInput.addEventListener("input", function() {
            var cursorPosition = salesInput.selectionStart;
            var cleanedValue = salesInput.value.replace(/,/g, ""); // Remove existing commas
            salesInput.value = formatNumberInput(cleanedValue);
            salesInput.setSelectionRange(cursorPosition, cursorPosition); // Maintain cursor position
        });

        // Remove commas before submitting the form
        document.querySelector("form").addEventListener("submit", function() {
            salesInput.value = salesInput.value.replace(/,/g, "");
        });
    });
</script>
{% endblock %}
